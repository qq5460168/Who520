name: Rule Syntax Check

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'

jobs:
  rule-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Make check script executable
        run: chmod +x ./SH/check_rules.sh

      - name: Run Syntax Checker
        run: |
          # å³ä½¿æœ‰é”™è¯¯ä¹Ÿç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
          ./SH/check_rules.sh || true
          echo "æ£€æŸ¥å®Œæˆï¼Œé”™è¯¯è§„åˆ™æœªè¢«åˆ é™¤"

      - name: Commit Reports to Repository
        run: |
          # é…ç½®Gitç”¨æˆ·
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # æ·»åŠ æŠ¥å‘Šæ–‡ä»¶
          git add rule_reports/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff-index --quiet HEAD --; then
            echo "æ— æ–°æŠ¥å‘Šå¯æäº¤"
          else
            git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–°è§„åˆ™æ£€æŸ¥æŠ¥å‘Š [skip ci]"
            git push
          fi

      - name: Create Summary Comment
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let summary = `### ğŸ› ï¸ è§„åˆ™æ£€æŸ¥æŠ¥å‘Šç”Ÿæˆå®Œæˆ\n`;
            summary += `**ç”Ÿæˆæ—¶é—´:** ${new Date().toLocaleString()}\n\n`;
            
            try {
              const logContent = fs.readFileSync('rule_reports/rule-check.log', 'utf8');
              const errorMatch = logContent.match(/é”™è¯¯è§„åˆ™æ€»æ•°: (\d+)/);
              const errorCount = errorMatch ? parseInt(errorMatch[1]) : 0;
              
              summary += `**é”™è¯¯è§„åˆ™æ€»æ•°:** ${errorCount}\n\n`;
              
              if (errorCount > 0) {
                summary += `**âš ï¸ æ£€æµ‹åˆ°é”™è¯¯è§„åˆ™!** é”™è¯¯è§„åˆ™æœªè¢«åˆ é™¤ï¼Œè¯·æ‰‹åŠ¨ä¿®å¤ã€‚\n`;
                summary += `æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š:\n`;
                summary += `- [æ ¼å¼åŒ–é”™è¯¯æŠ¥å‘Š](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${context.sha}/rule_reports/formatted-error.md)\n`;
                summary += `- [åŸå§‹é”™è¯¯æ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${context.sha}/rule_reports/error.txt)\n`;
                summary += `- [å®Œæ•´æ£€æŸ¥æ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${context.sha}/rule_reports/rule-check.log)\n\n`;
                
                summary += `**æ³¨æ„:** é”™è¯¯è§„åˆ™æœªè¢«åˆ é™¤ï¼Œè¯·æ ¹æ®æŠ¥å‘Šæ‰‹åŠ¨ä¿®å¤ã€‚`;
              } else {
                summary += `**âœ… æœªå‘ç°é”™è¯¯è§„åˆ™!** æ‰€æœ‰è§„åˆ™æ ¼å¼æ­£ç¡®ã€‚\n`;
                summary += `æŸ¥çœ‹[å®Œæ•´æ£€æŸ¥æ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${context.sha}/rule_reports/rule-check.log)`;
              }
            } catch (e) {
              summary = `âŒ ç”ŸæˆæŠ¥å‘Šæ—¶å‡ºé”™: ${e.message}`;
            }
            
            // åœ¨å·¥ä½œæµè¿è¡Œä¸­æ·»åŠ æ€»ç»“è¯„è®º
            github.rest.actions.createWorkflowRunComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
              body: summary
            });
