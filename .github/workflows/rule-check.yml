name: Rule Syntax Check

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'

jobs:
  rule-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # 允许后续提交更改
          fetch-depth: 0  # 获取完整历史

      - name: Make check script executable
        run: chmod +x ./SH/check_rules.sh

      - name: Run Syntax Checker
        run: |
          ./SH/check_rules.sh
          echo "报告位置: $(pwd)/rule_reports"
          ls -la rule_reports

      - name: Commit Reports to Repository
        run: |
          # 配置Git用户
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # 添加报告文件
          git add rule_reports/
          
          # 检查是否有变化
          if git diff-index --quiet HEAD --; then
            echo "无新报告可提交"
          else
            git commit -m "自动更新规则检查报告 [skip ci]"
            git push
          fi

      - name: Create GitHub Issue on errors
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('rule_reports/error.txt', 'utf8');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[自动报告] 发现无效规则`,
              body: `检测到无效规则需要处理：\n\n\`\`\`\n${report}\n\`\`\`\n\n请查看完整报告: rule_reports/error.txt`,
              labels: ['bug', 'rules']
            });